<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dara Story</title>

<style>
body {
  background: transparent;
  padding: 10px;
  line-height: 1.5;
  font-family: Arial, sans-serif;
  color: #fff;
}

#story {
  color: #ffffff;
  height: 100vh;
  max-height: none;
  overflow-y: auto;
  padding-top: 44px; /* space for logout button */
}

/* ---------- CHAT WITH AVATARS ---------- */
.chat-msg {
  display: flex;
  align-items: flex-start;
  gap: 8px;
  margin-bottom: 8px;
}

.chat-avatar {
  width: 26px;
  height: 26px;
  border-radius: 50%;
  flex-shrink: 0;
  margin-top: 2px;

  background: rgba(0,0,0,0.4);
  border: 1px solid rgba(120,140,200,0.25);
}

/* message bubble */
.chat-body {
  padding: 8px 10px;
  border-radius: 8px;
  background: rgba(8,12,20,0.65);
  border: 1px solid rgba(80,100,160,0.15);
  line-height: 1.4;
  flex: 1;
}

/* Variants */
.chat-msg.system .chat-body {
  color: #9aa7ff;
  font-family: monospace;
  background: rgba(20,30,60,0.4);
}

.chat-msg.station .chat-body { color: #ffd6d6; }
.chat-msg.ai .chat-body      { color: #c6f0ff; }
.chat-msg.control .chat-body {
  color: #d4e0ff;
  background: rgba(20,30,40,0.7);
}

.muted {
  opacity: 0.75;
}

/* ---------- TOP LOGOUT BUTTON ---------- */
.top-logout-btn {
  position: fixed;
  top: 10px;
  right: 10px;
  z-index: 1000;

  padding: 8px 14px;
  border-radius: 10px;
  border: 1px solid #2a3340;
  background: rgba(10,14,20,0.75);
  color: #e6e6e6;
  font-size: 13px;
  cursor: pointer;

  backdrop-filter: blur(6px);
}

.top-logout-btn:active {
  transform: translateY(1px);
}
</style>
</head>

<body>
<button id="btnLogout" class="top-logout-btn">
  Logout
</button>
  <div id="story">Waiting for Chianaâ€¦</div>

<script>
  // ============================================================
  // Logout button
  // ============================================================
  document.getElementById("btnLogout").addEventListener("click", () => {
  // tell parent to logout
  window.parent.postMessage({ type: "LOGOUT" }, "*");
});
  // ============================================================
  // Auth helpers (Google-only)
  // ============================================================

  function getToken() {
    return localStorage.getItem("sessionToken") || "";
  }

  function authHeaders(extra = {}) {
    const t = getToken();
    if (!t) return extra;
    return { ...extra, "Authorization": "Bearer " + t };
  }

  // ============================================================
  // Endpoint config (recommended: same origin via reverse proxy)
  // ============================================================

  const STORY_URL = "/api/v001/darawebgame/story";

  // If you MUST call cross-origin:
  // const STORY_URL = "https://gameinfo.daraempire.com/api/v001/darawebgame/story";

  // ============================================================
  // UI settings
  // ============================================================

  const STORY_ICON_URL =
    "https://gameinfo.daraempire.com/wp-content/uploads/2026/01/JumpAttack-150x150.png";

  const storyDiv = document.getElementById("story");
  const storyHistory = [];
  const MAX_STORY_LINES = 10;
  let lastNarrative = "";

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  function escapeHtml(s) {
  return String(s).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}

// preserve newlines in narrative
function toSafeHtmlWithBreaks(s) {
  return escapeHtml(s).replace(/\n/g, "<br>");
}

function renderStory() {
  storyDiv.innerHTML = storyHistory
    .map(t => `
      <div class="chat-msg ai">
        <img class="chat-avatar" src="${STORY_ICON_URL}" alt="Chiana">
        <div class="chat-body">
          ${toSafeHtmlWithBreaks(t)}
        </div>
      </div>
    `)
    .join("");

  storyDiv.scrollTop = storyDiv.scrollHeight;
}

  async function loadStory() {
    try {
      const token = getToken();
      if (!token) {
        storyDiv.innerHTML = `<div class="muted">Not logged in. Please login on the main page.</div>`;
        return;
      }

      const res = await fetch(STORY_URL, {
        headers: authHeaders(),
        cache: "no-store"
      });

      if (res.status === 401) {
        storyDiv.innerHTML = `<div class="muted">Unauthorized. Please login again on the main page.</div>`;
        return;
      }

      if (!res.ok) {
        const txt = await res.text();
        storyDiv.innerHTML = `<div class="muted">Story error: HTTP ${res.status}<br>${escapeHtml(txt)}</div>`;
        return;
      }

      const s = await res.json();

      //const narrative = (s.narrative ?? "").trim();
      const narrative= "new Message"+ Math.floor(Math.random()*100); // TESTING ONLY
      if (!narrative) return;

      // only add if it actually changed
      if (narrative === lastNarrative) return;
      lastNarrative = narrative;

      storyHistory.push(narrative);
      if (storyHistory.length > MAX_STORY_LINES) storyHistory.shift();

      renderStory();
    } catch (e) {
      console.error("loadStory failed:", e);
      storyDiv.innerHTML = `<div class="muted">loadStory failed: ${escapeHtml(String(e))}</div>`;
    }
  }

  setInterval(loadStory, 2000);
  loadStory();
</script>
</body>
</html>

