<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Dara – GameMaster UI</title>

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    :root{
      --gap: 10px;
      --panel-radius: 10px;
      --border: #2a3340;
      --bg: rgba(10,14,20,0.95);
    }
    body {
      margin: 0;
      background: #05070b;
      font-family: Arial, sans-serif;
      color: #e6e6e6;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    /* ---------- LOGIN SCREEN ---------- */
    #loginOverlay {
      position: fixed;
      inset: 0;
      overflow: hidden;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .login-bg {
      position: absolute;
      inset: 0;
      background-image: url("https://gameinfo.daraempire.com/wp-content/uploads/2024/12/DelcoCityAtNight.jpg");
      background-size: cover;
      background-position: center;
      filter: brightness(0.6) saturate(1.2);
      transform: scale(1.05);
    }

    .login-overlay {
      position: absolute;
      inset: 0;
      background:
        radial-gradient(circle at center, rgba(30,40,80,0.15), rgba(5,7,11,0.9)),
        linear-gradient(to top, rgba(5,7,11,0.95), rgba(5,7,11,0.3));
    }

    .login-content {
      position: relative;
      z-index: 2;
      max-width: 420px;
      width: calc(100% - 32px);
      padding: 28px 22px;
      text-align: center;

      background: rgba(12,16,30,0.85);
      border: 1px solid #2a3340;
      border-radius: 14px;
      backdrop-filter: blur(8px);
      box-shadow: 0 0 40px rgba(0,0,0,0.6);
    }

    .login-content h1 {
      margin: 0 0 10px;
      font-size: clamp(22px, 6vw, 28px);
      letter-spacing: 1px;
    }

    .login-icon {
      width: 64px;
      height: 64px;
      margin: 0 auto 14px;
      display: block;
      image-rendering: auto;
      filter: drop-shadow(0 0 8px rgba(255,80,80,0.4));
      animation: distressPulse 2.5s ease-in-out infinite;
    }

    @keyframes distressPulse {
      0%   { transform: scale(1);   opacity: 0.9; }
      50%  { transform: scale(1.06); opacity: 1; }
      100% { transform: scale(1);   opacity: 0.9; }
    }

    /* ---------- LOGIN CHAT ---------- */
    .login-chat {
      text-align: left;
      margin-bottom: 18px;
      font-size: clamp(13px, 3.6vw, 15px);
      line-height: 1.4;
    }

    .chat-line {
      margin-bottom: 8px;
      padding: 8px 10px;
      border-radius: 8px;
      background: rgba(8,12,20,0.65);
      border: 1px solid rgba(80,100,160,0.15);
    }

    .chat-line.system {
      color: #9aa7ff;
      font-family: monospace;
      background: rgba(20,30,60,0.4);
    }

    .chat-line.station { color: #ffd6d6; }
    .chat-line.ai      { color: #c6f0ff; }
    .chat-line.control {
      color: #d4e0ff;
      background: rgba(20,30,40,0.7);
    }
    /* ---------- CHAT WITH AVATARS ---------- */
    .chat-msg {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 8px;
    }

    .chat-avatar {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      flex-shrink: 0;
      margin-top: 2px;

      background: rgba(0,0,0,0.4);
      border: 1px solid rgba(120,140,200,0.25);
    }

    /* message bubble */
    .chat-body {
      padding: 8px 10px;
      border-radius: 8px;
      background: rgba(8,12,20,0.65);
      border: 1px solid rgba(80,100,160,0.15);
      line-height: 1.4;
      flex: 1;
    }

    /* Variants */
    .chat-msg.system .chat-body {
      color: #9aa7ff;
      font-family: monospace;
      background: rgba(20,30,60,0.4);
    }

    .chat-msg.station .chat-body { color: #ffd6d6; }
    .chat-msg.ai .chat-body      { color: #c6f0ff; }
    .chat-msg.control .chat-body {
      color: #d4e0ff;
      background: rgba(20,30,40,0.7);
    }


    /********* Character select */
    #charOverlay{
      position: fixed;
      inset: 0;
      overflow: hidden;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .char-item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 10px;
      border-radius: 10px;
      border: 1px solid rgba(120,140,200,0.18);
      background: rgba(8,12,20,0.55);
    }
    .char-left{
      display:flex;
      gap: 10px;
      align-items:center;
      min-width:0;
    }
    .char-avatar{
      width: 34px;
      height: 34px;
      border-radius: 10px;
      border: 1px solid rgba(120,140,200,0.25);
      background-color: rgba(122,167,255,0.14); 
      flex: 0 0 auto;
    }
    .char-meta{ min-width:0; }
    .char-name{
      margin:0;
      font-size: 14px;
      color:#fff;
    }
    .char-sub{
      margin:2px 0 0;
      font-size: 12px;
      color:#9aa6b2;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 320px;
    }
    .char-btn{
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #2a3340;
      background: rgba(10,14,20,0.6);
      color: #e6e6e6;
      cursor: pointer;
      font-size: 13px;
      white-space:nowrap;
    }
    .char-btn:active{ transform: translateY(1px); }
    /********* end Character select */
    /* begin char btn delete */

    .char-btn.delete{
      border-color: rgba(220,80,80,0.6);
      background: rgba(80,20,20,0.55);
      color: #ffd6d6;
    }

    .char-btn.delete:hover{
      background: rgba(120,30,30,0.65);
    }

    .char-btn.delete:active{
      transform: translateY(1px);
    }

    .char-btn.confirm{
      border-color: rgba(255,120,120,0.8);
      background: rgba(120,30,30,0.75);
      color: #fff;
      box-shadow: 0 0 10px rgba(255,80,80,0.35);
    }

    .char-btn.cancel{
      border-color: rgba(120,140,200,0.35);
      background: rgba(20,30,50,0.55);
      color: #d4e0ff;
    }

    /* end char btn delete */
    
    .google-login-wrap {
      display: flex;
      justify-content: center;
      width: 100%;
      margin-top: 6px;
    }

    .reset-login-btn{
      width: 100%;
      margin-top: 12px;
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid #2a3340;
      background: rgba(10,14,20,0.6);
      color: #e6e6e6;
      font-size: 14px;
      cursor: pointer;
    }

    .reset-login-btn:active{
      transform: translateY(1px);
    }

    

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
        grid-template-rows: auto;
        grid-template-areas:
          "hud"
          "log"
          "story";
      }
      .panel { min-height: 160px; }
      #hudFrame { height: 400px; }
      #combatLogFrame { height: 160px; }
      #storyFrame { height: calc(100dvh - 200px - 260px - (var(--gap) * 4)); }
    }

    @media (max-width: 420px) {
      #hudFrame { height: 320px; }
      #combatLogFrame { height: 140px; }
    }

    /* =========================
   MOBILE LANDSCAPE: keep full login visible
   ========================= */
@media (orientation: landscape) and (max-width: 1024px){

  /* Allow the overlay to scroll if content is taller than the screen */
  #loginOverlay{
    align-items: flex-start;     /* don’t vertically center (causes cut-off) */
    justify-content: center;
    overflow-y: auto;            /* IMPORTANT */
    -webkit-overflow-scrolling: touch;
    padding: 10px 0;             /* gives top/bottom breathing room */
  }

  /* Make the content box a bit shorter */
  .login-content{
    padding: 16px 16px;
    max-width: 520px;            /* can be wider in landscape */
    width: calc(100% - 24px);
    margin: 10px 0;
  }

  /* Reduce big elements so it fits */
  .login-icon{
    width: 44px;
    height: 44px;
    margin-bottom: 10px;
  }

  /* Make chat tighter so it doesn’t push the button below the fold */
  .login-chat{
    margin-bottom: 12px;
    font-size: 13px;
    line-height: 1.3;
  }
  .chat-msg{ margin-bottom: 6px; }
  .chat-body{ padding: 6px 8px; }
  .chat-avatar{ width: 22px; height: 22px; }

  /* Ensure Google button area doesn’t add extra vertical gaps */
  .google-login-wrap{ margin-top: 4px; }
  .reset-login-btn{ margin-top: 10px; padding: 10px 12px; }
}
  /* Leaderboards avatar */
.best-avatar{
  width: 34px;
  height: 34px;
  border-radius: 10px;
  border: 1px solid rgba(120,140,200,0.25);
  background: rgba(122,167,255,0.14);
  flex: 0 0 auto;
  background-size: cover;
  background-position: center;
}

.best-leftRow{
  display:flex;
  align-items:center;
  gap: 10px;
  min-width:0;
}

 /* ===== BEGIN BEST LISTS OVERLAY (COMPACT) ===== */
#bestOverlay{
  position: fixed;
  inset: 0;
  z-index: 10000;
  display: none;

  /* allow background to stay fixed while panel is centered */
  align-items: center;
  justify-content: center;

  /* IMPORTANT: no page-scroll; panel handles its own scroll */
  overflow: hidden;
}

/* Make the panel never exceed viewport height */
#bestOverlay .login-content{
  width: calc(100% - 32px);
  max-width: 720px;
  max-height: min(92dvh, 920px);
  overflow: hidden; /* we scroll inside the body area */
}

/* Header row with controls */
.best-toprow{
  display:flex;
  flex-direction: column;
  gap:10px;
  margin: 8px 0 12px;
  text-align:left;
}

.best-controls{
  display:flex;
  flex-wrap: wrap;
  gap: 8px;
  align-items:center;
  justify-content: space-between;
}

.best-seg{
  display:inline-flex;
  gap:6px;
  padding: 6px;
  border-radius: 12px;
  border: 1px solid rgba(120,140,200,0.20);
  background: rgba(0,0,0,0.18);
}

.best-tab{
  padding: 7px 10px;
  border-radius: 10px;
  border: 1px solid rgba(120,140,200,0.18);
  background: rgba(10,14,20,0.45);
  color: #e6e6e6;
  cursor: pointer;
  font-size: 12px;
  white-space: nowrap;
}
.best-tab.active{
  background: rgba(122,167,255,0.18);
  border-color: rgba(122,167,255,0.35);
}

/* Scrollable content area inside the panel */
.best-body{
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  max-height: calc(min(92dvh, 920px) - 260px); /* keep header + buttons visible */
  padding-right: 2px;
}

.best-card{
  border-radius: 12px;
  border: 1px solid rgba(120,140,200,0.18);
  background: rgba(8,12,20,0.55);
  padding: 10px;
  text-align:left;
  margin-bottom: 10px;
}

.best-card h3{
  margin: 0 0 8px;
  font-size: 14px;
  color: #fff;
  letter-spacing: 0.2px;
  display:flex;
  justify-content: space-between;
  gap: 10px;
  align-items: center;
}

.best-badge{
  font-size: 11px;
  color:#d4e0ff;
  border:1px solid rgba(120,140,200,0.25);
  background: rgba(20,30,50,0.45);
  padding: 3px 8px;
  border-radius: 999px;
  white-space: nowrap;
}

.best-list{
  display:grid;
  gap: 6px;
  margin: 0;
  padding: 0;
  list-style: none;
}

.best-row{
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 10px;
  padding: 8px 8px;
  border-radius: 10px;
  border: 1px solid rgba(120,140,200,0.12);
  background: rgba(0,0,0,0.18);
}

.best-left{
  min-width:0;
  display:flex;
  flex-direction: column;
  gap: 2px;
}

.best-title{
  font-size: 13px;
  color:#fff;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  max-width: 360px;
}

.best-sub{
  font-size: 12px;
  color:#9aa6b2;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  max-width: 360px;
}

.best-val{
  font-size: 13px;
  color:#e6e6e6;
  white-space:nowrap;
}

.best-my{
  border-color: rgba(255,255,255,0.14);
  background: rgba(122,167,255,0.12);
}

.best-muted{
  color:#9aa6b2;
  font-size: 12px;
}

.best-error{
  border: 1px solid rgba(255,80,80,0.35);
  background: rgba(80,20,20,0.35);
  color: #ffd6d6;
  border-radius: 10px;
  padding: 10px;
  font-size: 13px;
}
/* ===== END BEST LISTS OVERLAY (COMPACT) ===== */

/* ===== AVATAR PICKER ===== */
.av-body{
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  max-height: calc(min(92dvh, 920px) - 240px);
  padding-right: 2px;
  text-align: left;
}

.av-section{ margin-top: 10px; }
.av-title{ font-weight: 700; margin: 6px 0; }
.av-subtitle{ color: #9aa6b2; font-size: 12px; margin-bottom: 6px; }

.av-grid{
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(92px, 1fr));
  gap: 10px;
}

.av-card{
  position: relative;
  border: 1px solid rgba(120,140,200,0.18);
  background: rgba(8,12,20,0.55);
  border-radius: 10px;
  padding: 6px;
  cursor: pointer;
}

.av-card:hover{
  border-color: rgba(122,167,255,0.35);
}

.av-card.locked{
  opacity: 0.55;
  cursor: not-allowed;
}

.av-card.selected{
  border-color: rgba(122,167,255,0.55);
  box-shadow: 0 0 0 2px rgba(122,167,255,0.12) inset;
}

.av-img{
  width: 100%;
  height: 92px;
  object-fit: cover;
  border-radius: 8px;
  display: block;
  background: rgba(0,0,0,0.25);
}

.av-tier{
  position: absolute;
  top: 6px;
  left: 6px;
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 999px;
  border: 1px solid rgba(120,140,200,0.25);
  background: rgba(10,14,20,0.85);
  color: #e6e6e6;
}

.av-lock{
  position: absolute;
  bottom: 6px;
  right: 6px;
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 999px;
  border: 1px solid rgba(120,140,200,0.25);
  background: rgba(10,14,20,0.85);
  color: #e6e6e6;
}
.newchar-row{
  display:flex;
  align-items:center;
  gap: 10px;
}

.avatar-mini-btn{
  width: 64px;
  height: 64px;
  padding: 0;
  border-radius: 10px;
  border: 1px solid rgba(120,140,200,0.25);
  background: rgba(8,12,20,0.55);
  cursor: pointer;
  flex: 0 0 auto;
}

.avatar-mini-btn:active{ transform: translateY(1px); }

.avatar-mini-prev{
  width: 100%;
  height: 100%;
  border-radius: 12px;
  background: rgba(122,167,255,0.14);
  background-size: cover;
  background-position: center;
}

.avatar-mini-btn{
  position: relative; /* IMPORTANT for overlay positioning */
  overflow: hidden;   /* keeps overlay inside rounded corners */
}

.avatar-mini-hint{
  position: absolute;
  right: 6px;
  bottom: 6px;
  width: 18px;
  height: 18px;
  opacity: 0.85;
  pointer-events: none; /* click goes through to button */
  filter: drop-shadow(0 0 6px rgba(0,0,0,0.7));
}

/* when avatar selected -> hide hint icon */
.avatar-mini-btn.has-avatar .avatar-mini-hint{
  display: none;
}



#avatarOverlay{
  position: fixed;
  inset: 0;
  z-index: 10001;
  display: none;
  align-items:center;
  justify-content:center;
  overflow:hidden;
}
#avatarOverlay .login-content{
  max-height: min(92dvh, 920px);
  overflow: hidden;
}


/* Avatar picker end */
/* help and imprint buttons */
.help-imprint-bar {
  display: flex;
  gap: 10px;
  justify-content: center;
  align-items: center;
  margin-top: 12px;
}

.ui-btn {
  padding: 8px 14px;
  border-radius: 8px;
  border: 1px solid #2a3340;
  background: rgba(20,25,35,0.9);
  color: #e6e6e6;
  cursor: pointer;
  font-size: 14px;
}

.ui-btn:hover {
  background: rgba(40,50,70,0.95);
}

.ui-btn.imprint {
  opacity: 0.85;
}
/* end help and imprint buttons */


  </style>
</head>

<body>

  <!-- ================= LOGIN OVERLAY ================= -->
  <div id="loginOverlay">
    <div class="login-bg"></div>
    <div class="login-overlay"></div>

    <div class="login-content">
      <img
        src="https://gameinfo.daraempire.com/wp-content/uploads/2026/01/AttentionSignal-300x300.png"
        alt="Distress Signal"
        class="login-icon"
      />

      <h1>Dara III Marina Station: Last Stand</h1>
      <!-- START login chat -->
<div class="login-chat">

  <div class="chat-msg station">
    <img class="chat-avatar" src="https://gameinfo.daraempire.com/wp-content/uploads/2026/01/MSAgent-Soldorn-300x300.jpg">
    <div class="chat-body">
      Today its foggy on Marina Station.<br>
      Wait... I see something in the distance.<br>
    </div>
  </div>

  <div class="chat-msg system">
    <img class="chat-avatar" src="https://gameinfo.daraempire.com/wp-content/uploads/2026/01/MSAgent-Soldorn-300x300.jpg">
    <div class="chat-body">
      [ Distress Channel Opened ]
    </div>
  </div>


  <div class="chat-msg ai">
    <img class="chat-avatar" src="https://gameinfo.daraempire.com/wp-content/uploads/2026/01/MSAgent-Tira-300x300.jpg">
    <div class="chat-body">
      Any agent receiving this transmission,<br>
      Marina Station is under attack!!!
    </div>
  </div>

  <div class="chat-msg control">
    <img class="chat-avatar" src="https://gameinfo.daraempire.com/wp-content/uploads/2026/01/MSAgent-Christi-300x300.jpg">
    <div class="chat-body">
      All available operatives: Help!
    </div>
  </div>

  <div class="chat-msg system">
    <img class="chat-avatar" src="https://gameinfo.daraempire.com/wp-content/uploads/2026/01/MSAgent-Turnario-300x300.jpg">
    <div class="chat-body">
      &gt;&gt; Awaiting authentication to port…
    </div>
  </div>

</div>
      <!-- End login chat -->
      <!-- Google GSI config (callback must be global) -->
      <div id="g_id_onload"
           data-client_id="510527062283-5v7dtu9tug798ba5bvcost3ur0at9grn.apps.googleusercontent.com"
           data-callback="onGoogleCredential"
           data-auto_prompt="false">
      </div>

      <!-- We render the button into this container via JS (so we can re-render on reset) -->
      <div class="google-login-wrap">
        <div id="googleBtn"></div>
      </div>

      <button id="btnResetLogin" class="reset-login-btn" type="button">
        Use other account
      </button>
      <div class="help-imprint-bar">
        <button class="ui-btn" onclick="openHelp()">Help</button>
        <button class="ui-btn imprint" onclick="openImprint()">Legal notice</button>
      </div>
    </div>


</div>
  
<!-- ================= CHARACTER SELECT OVERLAY ================= -->
<div id="charOverlay" style="display:none;">
  <div class="login-bg"></div>
  <div class="login-overlay"></div>

  <div class="login-content" style="max-width: 520px;">
    <img
      src="https://gameinfo.daraempire.com/wp-content/uploads/2026/01/AttentionSignal-300x300.png"
      alt="Agent Console"
      class="login-icon"
      style="filter: drop-shadow(0 0 10px rgba(122,167,255,0.35));"
    />

    <h1>Choose your Agent</h1>

    <div class="login-chat" style="margin-bottom: 12px;">
      <div class="chat-msg system">
        <img class="chat-avatar" src="https://gameinfo.daraempire.com/wp-content/uploads/2026/01/MSAgent-Turnario-300x300.jpg">
        <div class="chat-body">
          &gt;&gt; Authentication OK<br>
          &gt;&gt; Select existing agent or create a new identity…
        </div>
      </div>
      <div class="chat-msg control">
        <img class="chat-avatar" src="https://gameinfo.daraempire.com/wp-content/uploads/2026/01/MSAgent-Christi-300x300.jpg">
        <div class="chat-body">
          Logged in as: <span id="whoAmI" style="color:#fff"></span>
        </div>
      </div>
    </div>

    <!-- Character list -->
    <div id="charList" style="text-align:left; display:grid; gap:10px; margin-bottom: 10px;"></div>

    <!-- Create new character -->
    <div style="text-align:left; border-top: 1px solid rgba(255,255,255,0.08); padding-top: 12px; margin-top: 10px;">
      <div style="font-size: 12px; color:#9aa6b2; margin-bottom: 6px;">Create new Agent</div>
      <div class="newchar-row" style="margin-top:10px;">
        <button id="btnPickAvatar" class="avatar-mini-btn" type="button" title="Pick Avatar">
          <div id="newCharAvatarPreview" class="avatar-mini-prev"></div>

          <!-- overlay icon (hidden once avatar selected) -->
          <img id="avatarPickHintIcon"
              class="avatar-mini-hint"
              src="https://gameinfo.daraempire.com/game-res/avatars/standard/VexEchoPrime.png"
              alt="Pick avatar">
        </button>

        <input id="newCharName"
              type="text"
              placeholder="CharacterName (e.g. Arikara-296)"
              maxlength="20"
              style="flex:1; height:64px; border-radius:10px; border:1px solid #2a3340;
                      background: rgba(10,14,20,0.6); color:#e6e6e6; padding:0 12px; outline:none;" />
        <button id="btnCreateChar" class="reset-login-btn" type="button" style="margin-top:0;flex:1;height:64px;">
          Create Agent
        </button>
      </div>
    </div>
    <div class="char-actions-row">
      <button id="btnBestLists" class="reset-login-btn" type="button" style="margin-top:10px;">
        Best Lists (Weekly / Overall)
      </button>
    </div>

    <button id="btnBackToLogin" class="reset-login-btn" type="button" style="margin-top:10px;">
      Logout / Switch account
    </button>
  </div>
</div>
<!-- End Character list overlay -->

<!-- ================= BEST LISTS OVERLAY (COMPACT) ================= -->
<div id="bestOverlay">
  <div class="login-bg"></div>
  <div class="login-overlay"></div>

  <div class="login-content">
    <img
      src="https://gameinfo.daraempire.com/wp-content/uploads/2026/01/AttentionSignal-300x300.png"
      alt="Leaderboards"
      class="login-icon"
      style="filter: drop-shadow(0 0 10px rgba(255,200,120,0.20));"
    />

    <h1 style="margin-bottom:6px;">Best Agents</h1>

    <div class="best-toprow">
      <div class="best-controls">
        <!-- Period toggle -->
        <div class="best-seg" id="bestPeriodSeg">
          <button class="best-tab active" type="button" data-period="weekly">Weekly</button>
          <button class="best-tab" type="button" data-period="overall">Overall</button>
        </div>

        <!-- Action buttons -->
        <div style="display:flex; gap:10px;">
          <button id="btnBestRefresh" class="char-btn" type="button">Refresh</button>
          <button id="btnBestClose" class="char-btn" type="button">Back</button>
        </div>
      </div>

      <!-- Metric toggle -->
      <div class="best-seg" id="bestMetricSeg">
        <button class="best-tab active" type="button" data-metric="highestWave">Wave</button>
        <button class="best-tab" type="button" data-metric="highestLevel">Level</button>
        <button class="best-tab" type="button" data-metric="highestCredits">Credits</button>
        <button class="best-tab" type="button" data-metric="highestPotions">Potions</button>
      </div>

      <div class="best-muted" id="bestSubtitle">
        Showing Top 1–3 + your characters’ ranks
      </div>
    </div>

    <div id="bestHost" class="best-body"></div>

    <div style="margin-top:10px;" class="best-muted">
      Weekly uses character <code>StoreTime</code> (last 7 days). Overall uses all time.
    </div>
  </div>
</div>
<!-- ================= END BEST LISTS OVERLAY (COMPACT) ================= -->

<!-- ================= AVATAR PICKER OVERLAY ================= -->
<div id="avatarOverlay" style="display:none;">
  <div class="login-bg"></div>
  <div class="login-overlay"></div>

  <div class="login-content" style="max-width: 820px;">
    <img
      src="https://gameinfo.daraempire.com/wp-content/uploads/2026/01/AttentionSignal-300x300.png"
      alt="Avatars"
      class="login-icon"
      style="filter: drop-shadow(0 0 10px rgba(122,167,255,0.25));"
    />
    <h1 style="margin-bottom:6px;">Choose Avatar</h1>

    <div style="display:flex; gap:10px; justify-content:space-between; align-items:center; margin: 10px 0 10px;">
      <div style="font-size:12px; color:#9aa6b2;">
        Standard: free. Premium: donors only.
        <span id="avatarPremiumState" style="color:#fff; margin-left:8px;"></span>
      </div>

      <div style="display:flex; gap:10px;">
        <button id="btnAvatarRefresh" class="char-btn" type="button">Refresh</button>
        <button id="btnAvatarClose" class="char-btn" type="button">Back</button>
      </div>
    </div>

    <div id="avatarPickerHost" class="av-body"></div>

    <div id="avatarSelectedOut" class="best-muted" style="margin-top:10px;">
      Selected: (none)
    </div>
  </div>
</div>
<!-- ================= END AVATAR PICKER OVERLAY ================= -->


  <script>
     // ---------- GOOGLE BUTTON RENDER ----------
    function renderGoogleButton() {
      const el = document.getElementById("googleBtn");
      if (!el) return;
      el.innerHTML = "";

      if (window.google?.accounts?.id) {
        google.accounts.id.renderButton(el, {
          type: "standard",
          size: "large",
          theme: "outline",
          text: "sign_in_with",
          shape: "rectangular"
        });
      }
    }

    // ---------- LOGOUT (from HUD iframe) ----------
    async function doLogout() {
      const token = localStorage.getItem("sessionToken") || "";
      localStorage.removeItem("sessionToken");
      localStorage.removeItem("playerName");

      if (token) {
        try {
          await fetch("/api/v001/darawebgame/logout", {
            method: "POST",
            headers: { "Authorization": "Bearer " + token }
          });
        } catch (e) {
          console.warn("logout call failed:", e);
        }
      }
      showLogin();
    }

    window.addEventListener("message", (ev) => {
      if (ev.data && ev.data.type === "LOGOUT") {
        doLogout();
      }
    });

    // ---------- SHOW GAME UI ----------
    function goToGame() {
    // optional: damit man nicht per "Back" wieder im eingeloggten Zustand landet
      window.location.replace("game.html");
    }

    // ---------- RESET / SWITCH ACCOUNT ----------
    async function resetGoogleLogin() {
      console.log("resetGoogleLogin clicked");

      // clear app session
      localStorage.removeItem("sessionToken");
      localStorage.removeItem("playerName");

      // disable auto-select / cancel OneTap
      if (window.google?.accounts?.id) {
        try {
          google.accounts.id.disableAutoSelect();
          google.accounts.id.cancel();
        } catch (e) {
          console.warn("google reset failed:", e);
        }
      }

      // show login and re-render button (forces UI refresh)
      showLogin();
    }


    // ---------- INIT ----------
    document.addEventListener("DOMContentLoaded", () => {
      // bind reset button
      const btn = document.getElementById("btnResetLogin");
      if (btn) btn.addEventListener("click", resetGoogleLogin);

      // wait for Google script (async) then render button
      const t = setInterval(() => {
        if (window.google?.accounts?.id) {
          clearInterval(t);
          renderGoogleButton();
        }
      }, 50);

      // auto-login on reload
      (async function autoLogin() {
        const token = localStorage.getItem("sessionToken");
        if (!token) {
          showLogin();
          return;
        }

        const r = await fetch("/me", {
          headers: { "Authorization": "Bearer " + token }
        });

        if (r.ok) {
          const me = await r.json().catch(()=> ({}));
          //g_isPremiumUser = !!me.isPremium;   // do not send it here.. only on characters respnse
          loadAndShowCharacters();
        } else {
          showLogin();
        }
      })();
    });

  updateAvatarMiniButtonState();

  /***********************
   * BEGIN Character Select 
   */
   let g_charCache = []; // keeps last loaded characters

  // --- overlay toggles ---
  function showLogin(){
    document.getElementById("loginOverlay").style.display = "flex";
    document.getElementById("charOverlay").style.display = "none";
    renderGoogleButton();
  }
  function showCharacterSelect(){
    document.getElementById("loginOverlay").style.display = "none";
    document.getElementById("charOverlay").style.display = "flex";
  }

  // --- helper: auth header ---
  function authHeader(){
    const token = localStorage.getItem("sessionToken") || "";
    return { "Authorization": "Bearer " + token };
  }

  // --- API calls (placeholders) ---
  async function apiGetCharacters(){
    const r = await fetch("/api/v001/darawebgame/characters", {
      headers: { ...authHeader() }
    });
    if (!r.ok) throw new Error("Could not load characters");
    return r.json(); // expected: { characters:[{characterId, characterName, level, className}] }
  }

  async function apiCreateCharacter(characterName){
    const r = await fetch("/api/v001/darawebgame/characters/create", {
      method: "POST",
      headers: { "Content-Type":"application/json", ...authHeader() },
      body: JSON.stringify({ characterName, avatarKey: g_selectedAvatarKey })
    });
    const j = await r.json().catch(()=> ({}));
    if (!r.ok) throw new Error(j.message || "Create failed");
    return j; // expected: { characterId, characterName }
  }

  async function apiDeleteCharacter(characterId){
    const r = await fetch("/api/v001/darawebgame/characters/delete", {
      method: "POST",
      headers: { "Content-Type":"application/json", ...authHeader() },
      body: JSON.stringify({ characterId })
    });

    const j = await r.json().catch(()=> ({}));
    if (!r.ok) throw new Error(j.message || "Delete failed");
    return j;
  }

  async function apiSelectCharacter(characterId){
    // optional: backend can set "active character" in session
    const r = await fetch("/api/v001/darawebgame/characters/select", {
      method: "POST",
      headers: { "Content-Type":"application/json", ...authHeader() },
      body: JSON.stringify({ characterId })
    });
    // if you don't need this endpoint, you can remove it and just redirect to game.html
    if (!r.ok) {
      const j = await r.json().catch(()=> ({}));
      throw new Error(j.message || "Select failed");
    }
  }
  
  function avatarKeyToUrl(avatarKey){
    const k = String(avatarKey || "").trim();
    if (!k) return "";
    if (k.startsWith("http")) return k;
    // avatarKey like "standard/Name.png" or "premium/Name.png"
    return AVATAR_BASE_URL.replace(/\/+$/,"") + "/" + k;
  }


  // --- render character list ---
  function renderCharacterList(chars){
    const host = document.getElementById("charList");
    host.innerHTML = "";

    if (!chars || chars.length === 0){
      host.innerHTML = `<div class="chat-line control" style="margin:0;">
        No agents found. Create your first Agent/Character below.
      </div>`;
      return;
    }

    for (const c of chars){
      const div = document.createElement("div");
      div.className = "char-item";

      const lvl = (c.level ?? 1);
      const cls = (c.className ?? "Operative");
      const cid = c.characterId ?? c.id ?? "";
      const cname = c.characterName ?? c.name ?? "Unknown";
      
      const avatarKey = String(c.avatar || c.Avatar || "").trim(); // accept avatar or Avatar
      const avatarUrl = avatarKeyToUrl(c.avatarKey || c.avatar || c.Avatar);


      div.innerHTML = `
        <div class="char-left">
        <div class="char-avatar" style="${
          avatarUrl
            ? `background-image:url('${avatarUrl}');background-size:cover;background-position:center;`
            : ""
        }"></div>
          <div class="char-meta">
            <p class="char-name">${escapeHtml(cname)}</p>
            <p class="char-sub">Level ${lvl} • ${escapeHtml(cls)} • ID ${escapeHtml(String(cid))}</p>
          </div>
        </div>
        <div style="display:flex; gap:6px;">
          <button class="char-btn enter" type="button">Enter</button>
          <button class="char-btn delete" type="button">Delete</button>
        </div>
      `;

    const btnEnter  = div.querySelector(".enter");
    const btnDelete = div.querySelector(".delete");

    btnEnter.addEventListener("click", async () => {
      try{
        if (cid) await apiSelectCharacter(cid);

        localStorage.setItem("characterId", String(cid));
        localStorage.setItem("characterName", String(cname));
        
        const url = new URL("game.html", window.location.href);
        if (cid) url.searchParams.set("characterId", cid);
        url.searchParams.set("characterName", cname);
        
        window.location.replace(url.toString());
      }catch(e){
        alert(e.message || "Failed to enter game");
      }
    });

    let confirmMode = false;
    let confirmTimer = null;

    btnDelete.addEventListener("click", async (ev) => {
      ev.stopPropagation();

      // First click → enter confirm mode
      if (!confirmMode){
        confirmMode = true;
        btnDelete.textContent = "Confirm";
        btnDelete.classList.add("confirm");

        // Insert Cancel button
        const btnCancel = document.createElement("button");
        btnCancel.className = "char-btn cancel";
        btnCancel.type = "button";
        btnCancel.textContent = "Cancel";

        btnDelete.after(btnCancel);

        // Auto-cancel after 4 seconds
        confirmTimer = setTimeout(resetConfirm, 4000);

        btnCancel.addEventListener("click", (e) => {
          e.stopPropagation();
          resetConfirm();
        });

        // Click anywhere else cancels
        const outsideCancel = () => resetConfirm();
        setTimeout(() => document.addEventListener("click", outsideCancel, { once:true }), 0);

        function resetConfirm(){
          if (!confirmMode) return;
          confirmMode = false;
          btnDelete.textContent = "Delete";
          btnDelete.classList.remove("confirm");
          btnCancel.remove();
          if (confirmTimer) clearTimeout(confirmTimer);
        }

        return;
      }

      // Second click → CONFIRMED
      try{
        btnDelete.disabled = true;
        await apiDeleteCharacter(cid);

        g_charCache = g_charCache.filter(x =>
          String(x.characterId ?? x.id) !== String(cid)
        );
        renderCharacterList(g_charCache);
      }catch(e){
        alert(e.message || "Delete failed");
      }
    });


      host.appendChild(div);
    }
  }

  // --- load chars + show overlay ---
  async function loadAndShowCharacters(){
    showCharacterSelect();

    const who = document.getElementById("whoAmI");
    who.textContent = localStorage.getItem("playerName") || "Unknown";

    try{
      const data = await apiGetCharacters();
      const chars = data.characters || data || [];

      g_charCache = Array.isArray(chars) ? chars : [];
      renderCharacterList(g_charCache);
    }catch(e){
      document.getElementById("charList").innerHTML =
        `<div class="chat-line system" style="margin:0;">[ Error loading characters: ${escapeHtml(e.message)} ]</div>`;
    }
  }


  // --- tiny sanitizer ---
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    }[m]));
  }

  // --- wire buttons ---
  document.addEventListener("DOMContentLoaded", () => {
    const back = document.getElementById("btnBackToLogin");
    if (back) back.addEventListener("click", async () => {
      // full logout + show login
      await doLogout(); // uses your existing function
    });

    const createBtn = document.getElementById("btnCreateChar");
    if (createBtn) createBtn.addEventListener("click", async () => {
      const inp = document.getElementById("newCharName");
      const name = (inp.value || "").trim();
      if (!name){
        alert("Please enter a character name");
        return;
      }

      try{
        createBtn.disabled = true;

        const created = await apiCreateCharacter(name);
        // expected from server:
        // { ok:true, characterId:"123", characterName:"Arikara-296", avatar:"..." }

        // Normalize object to match renderCharacterList expectations
        const newChar = {
          characterId: created.characterId,
          characterName: created.characterName || name,
          avatarKey: created.avatarKey || g_selectedAvatarKey || created.avatar || ""
        };

        // Add to cache (avoid duplicates if user double-clicked / retries)
        g_charCache = (g_charCache || []).filter(c => String(c.characterId) !== String(newChar.characterId));
        g_charCache.unshift(newChar); // put newest on top

        // Re-render instantly
        renderCharacterList(g_charCache);

        inp.value = "";
        inp.focus();
      }catch(e){
        alert(e.message || "Create failed");
      }finally{
        createBtn.disabled = false;
      }
    });


  });

  // --- MODIFY your Google callback to go to character select, not game ---
  async function onGoogleCredential(response) {
    const r = await fetch("/api/v001/darawebgame/auth/google", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ idToken: response.credential })
    });

    const j = await r.json();
    if (!r.ok) {
      alert(j.message || "Login failed");
      return;
    }

    localStorage.setItem("sessionToken", j.token);
    localStorage.setItem("playerName", j.playerName || "Unknown Agent");

    // NEW: show character select
    await loadAndShowCharacters();
  }

  // --- MODIFY your autoLogin: if token valid -> load characters instead of goToGame ---
  // Replace the part where you do goToGame() after /me is ok:
  // if (r.ok) { goToGame(); }  -->  if (r.ok) { loadAndShowCharacters(); }

   
  /***********************
   * END Character Select 
   */

   /***********************
   * BEGIN Best Lists
   */

  function avatarToUrl(avatarKey){
      return avatarKeyToUrl(avatarKey);
  }

  function showBestOverlay(){
    document.getElementById("bestOverlay").style.display = "flex";
    // keep charOverlay hidden while bestOverlay is open
    document.getElementById("charOverlay").style.display = "none";
  }

  function hideBestOverlay(){
    document.getElementById("bestOverlay").style.display = "none";
    document.getElementById("charOverlay").style.display = "flex";
  }

  function fmtRank(n){
    if (!n || n <= 0) return "—";
    return "#" + n;
  }




  // Expecting backend response shape:
  // {
  //   weekly: {
  //     highestWave: { top:[{characterId, characterName, userEmail, value}], my:[{characterId, rank, value}] },
  //     highestLevel: { ... },
  //     highestCredits: { ... },
  //     highestPotions: { ... }
  //   },
  //   overall: { ... same ... }
  // }
  async function apiGetLeaderboards(){
    const r = await fetch("/api/v001/darawebgame/leaderboards", {
      headers: { ...authHeader() }
    });

    // If you haven't implemented it yet, you'll likely get 404/501
    if (!r.ok){
      const txt = await r.text().catch(()=> "");
      throw new Error(`Leaderboards endpoint not available (${r.status}). ${txt ? "Details: " + txt : ""}`);
    }
    return r.json();
  }

  let g_lbData = null;
  let g_bestPeriod = "weekly";       // "weekly" | "overall"
  let g_bestMetric = "highestWave";  // one of your metric keys


  function metricLabel(key){
    switch(key){
      case "highestWave":   return "Highest Wave";
      case "highestLevel":  return "Highest Level";
      case "highestCredits":return "Highest Credits";
      case "highestPotions":return "Highest Potions";
      default: return key;
    }
  }

  function renderMetricCard(title, periodName, metricKey, metricData){
    const top = Array.isArray(metricData?.top) ? metricData.top : [];
    const my  = Array.isArray(metricData?.my)  ? metricData.my  : [];

    // Build quick lookup for "my ranks" by characterId
    const myById = new Map();
    for (const m of my){
      myById.set(String(m.characterId), m);
    }

    // Use your local cache so we can show "which of my characters" has which rank.
    const myChars = Array.isArray(g_charCache) ? g_charCache : [];

    const wrap = document.createElement("div");
    wrap.className = "best-card";

    wrap.innerHTML = `
      <h3>
        <span>${escapeHtml(title)}</span>
        <span class="best-badge">${escapeHtml(periodName)}</span>
      </h3>
      <div class="best-muted" style="margin-bottom:8px;">
        Top 1–3 globally + ranks for your characters (if ranked)
      </div>
      <div class="best-muted" style="margin-bottom:6px;">Top 3</div>
      <ul class="best-list" data-top></ul>

      <div class="best-muted" style="margin:10px 0 6px;">Your ranks</div>
      <ul class="best-list" data-my></ul>
    `;

    const ulTop = wrap.querySelector("[data-top]");
    const ulMy  = wrap.querySelector("[data-my]");

    // Top list
    if (top.length === 0){
      const li = document.createElement("div");
      li.className = "best-muted";
      li.textContent = "No data.";
      ulTop.appendChild(li);
    } else {
      top.slice(0,3).forEach((t, idx) => {
        const li = document.createElement("li");
        li.className = "best-row";

        const aurl = avatarToUrl(t.avatar);
        li.innerHTML = `
          <div class="best-leftRow">
            <div class="best-avatar" style="${
              aurl ? `background-image:url('${aurl}');` : ""
            }"></div>

            <div class="best-left">
              <div class="best-title">${idx+1}. ${escapeHtml(t.characterName || "Unknown")}</div>
              <div class="best-sub">ID ${escapeHtml(String(t.characterId ?? ""))}</div>
            </div>
          </div>

          <div class="best-val">${escapeHtml(String(t.value ?? "—"))}</div>
        `;

        ulTop.appendChild(li);
      });
    }

    // My ranks list (show all my chars + their rank/value if present)
    if (myChars.length === 0){
      const li = document.createElement("div");
      li.className = "best-muted";
      li.textContent = "No local characters loaded.";
      ulMy.appendChild(li);
    } else {
      for (const c of myChars){
        const cid = String(c.characterId ?? c.id ?? "");
        const cname = String(c.characterName ?? c.name ?? "Unknown");
        const mine = myById.get(cid);

        const rank = mine?.rank;
        const val  = mine?.value;
        const showRight = (val === undefined || val === null) ? fmtRank(rank) : String(val);

        // avatar from local character cache (or backend myPlaces if you prefer)
        const aurl = avatarToUrl(c.avatar || c.Avatar || mine?.avatar);

        const row = document.createElement("li");
        row.className = "best-row" + (rank ? " best-my" : "");

        row.innerHTML = `
          <div class="best-leftRow">
            <div class="best-avatar" style="${aurl ? `background-image:url('${aurl}');` : ""}"></div>
            <div class="best-left">
              <div class="best-title">${escapeHtml(cname)} <span class="best-muted">(${fmtRank(rank)})</span></div>
              <div class="best-sub">ID ${escapeHtml(cid)}</div>
            </div>
          </div>
          <div class="best-val">${escapeHtml(showRight)}</div>
        `;

        ulMy.appendChild(row);
      }

    }

    return wrap;
  }

  function setActiveTab(segEl, attr, value){
    const btns = segEl.querySelectorAll(".best-tab");
    btns.forEach(b => b.classList.toggle("active", b.getAttribute(attr) === value));
  }

  function renderBestView(){
    const host = document.getElementById("bestHost");
    host.innerHTML = "";

    if (!g_lbData){
      host.innerHTML = `<div class="best-card"><div class="best-muted">No data loaded.</div></div>`;
      return;
    }

    const periodTitle = (g_bestPeriod === "weekly") ? "Weekly (last 7 days)" : "Overall";
    const metricTitle = metricLabel(g_bestMetric);

    // reuse your existing card builder (top3 + my ranks)
    const card = renderMetricCard(metricTitle, periodTitle, g_bestMetric, g_lbData?.[g_bestPeriod]?.[g_bestMetric]);
    host.appendChild(card);

    // subtitle
    const subtitle = document.getElementById("bestSubtitle");
    if (subtitle){
      subtitle.textContent = `${periodTitle} • ${metricTitle} — Top 1–3 + your characters’ ranks`;
    }
  }

  function normalizeLeaderboards(serverData){
    const out = { weekly:{}, overall:{} };

    const metrics = ["highestWave","highestLevel","highestCredits","highestPotions"];

    // helper: get "top list" array safely
    const topList = (period, metric) => {
      const arr = serverData?.[period]?.[metric];
      return Array.isArray(arr) ? arr : [];
    };

    // helper: build "my list" from myPlaces
    const buildMy = (period, metric) => {
      const places = Array.isArray(serverData?.myPlaces) ? serverData.myPlaces : [];

      // pick correct rank field from myPlaces
      const rankField =
        (metric === "highestWave")    ? (period === "weekly" ? "rankWaveWeek"    : "rankWaveAll") :
        (metric === "highestLevel")   ? (period === "weekly" ? "rankLevelWeek"   : "rankLevelAll") :
        (metric === "highestCredits") ? (period === "weekly" ? "rankCreditsWeek" : "rankCreditsAll") :
        (metric === "highestPotions") ? (period === "weekly" ? "rankPotionsWeek" : "rankPotionsAll") :
        null;

      // Your backend myPlaces currently doesn't include the metric "value".
      // We'll still show rank, and show value as "—" unless you add it server-side.
      return places.map(p => ({
        characterId: p.characterId,
        rank: p?.[rankField] ?? null,
        value: p.value ?? "—",              // keep placeholder
        characterName: p.characterName,
        avatar: p.avatar
      }));
    };

    for (const period of ["weekly","overall"]){
      for (const m of metrics){
        out[period][m] = {
          top: topList(period, m),
          my: buildMy(period, m)
        };
      }
    }

    return out;
  }


  async function openBestLists(forceFetch=false){
    showBestOverlay();

    const host = document.getElementById("bestHost");
    host.innerHTML = `<div class="best-card"><div class="best-muted">Loading…</div></div>`;

    try{
      if (!g_lbData || forceFetch){
        const raw = await apiGetLeaderboards();
        g_lbData = normalizeLeaderboards(raw);
      }
      renderBestView(); // <-- ALWAYS render
    }catch(e){
      host.innerHTML = `
        <div class="best-error">
          <div style="font-weight:bold; margin-bottom:6px;">Could not load leaderboards</div>
          <div>${escapeHtml(e.message || "Unknown error")}</div>
        </div>
      `;
    }
  }



 document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("btnBestLists");
    if (btn) btn.addEventListener("click", () => openBestLists(false));

    const close = document.getElementById("btnBestClose");
    if (close) close.addEventListener("click", hideBestOverlay);

    const refresh = document.getElementById("btnBestRefresh");
    if (refresh) refresh.addEventListener("click", () => openBestLists(true));

    // Period tabs
    const periodSeg = document.getElementById("bestPeriodSeg");
    if (periodSeg){
      periodSeg.addEventListener("click", (ev) => {
        const b = ev.target.closest("button[data-period]");
        if (!b) return;
        g_bestPeriod = b.getAttribute("data-period");
        setActiveTab(periodSeg, "data-period", g_bestPeriod);
        renderBestView();
      });
    }

    // Metric tabs
    const metricSeg = document.getElementById("bestMetricSeg");
    if (metricSeg){
      metricSeg.addEventListener("click", (ev) => {
        const b = ev.target.closest("button[data-metric]");
        if (!b) return;
        g_bestMetric = b.getAttribute("data-metric");
        setActiveTab(metricSeg, "data-metric", g_bestMetric);
        renderBestView();
      });
    }
  });

  /***********************
   * END Best Lists
   */
/* ================= AVATAR PICKER (STANDARD/PREMIUM) ================= */

const AVATAR_INDEX_URL = "https://gameinfo.daraempire.com/game-res/avatars/avatars.json";
const AVATAR_BASE_URL="https://gameinfo.daraempire.com/game-res/avatars";
  

// selected avatar key to use for creation
let g_selectedAvatarKey = "";

// in-memory cache
let g_avatarIndex = null;

// set this based on /me response or login response (you can wire later)
let g_isPremiumUser = false;

function showAvatarOverlay(){
  document.getElementById("avatarOverlay").style.display = "flex";
  document.getElementById("charOverlay").style.display = "none";
  updatePremiumStateLabel();
}

function hideAvatarOverlay(){
  document.getElementById("avatarOverlay").style.display = "none";
  document.getElementById("charOverlay").style.display = "flex";
}

function updatePremiumStateLabel(){
  const el = document.getElementById("avatarPremiumState");
  if (!el) return;
  el.textContent = g_isPremiumUser ? "(premium: unlocked)" : "(premium: locked)";
}

async function loadAvatarIndex(force=false){
  if (g_avatarIndex && !force) return g_avatarIndex;
  const r = await fetch(AVATAR_INDEX_URL, { cache: "no-store" });
  if (!r.ok) throw new Error("Failed to load avatars.json: " + r.status);
  const j = await r.json();
  if (!j || !Array.isArray(j.avatars)) throw new Error("avatars.json invalid");
  g_avatarIndex = j;
  return j;
}

function escapeAttr(s){
  return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

function renderAvatarPicker(indexJson){
  const host = document.getElementById("avatarPickerHost");
  if (!host) return;

  const baseUrl = String(indexJson.baseUrl || "").replace(/\/+$/, "");
  const all = indexJson.avatars || [];

  const standard = all.filter(a => a.tier === "standard");
  const premium  = all.filter(a => a.tier === "premium");

  function avatarUrl(a){
    // safest: baseUrl + key. If baseUrl missing, fallback to a.url.
    if (baseUrl && a.key) return baseUrl + "/" + a.key;
    return a.url || "";
  }

  function card(a){
    const key = String(a.key || "");
    const tier = String(a.tier || "standard");
    const locked = (tier === "premium" && !g_isPremiumUser);
    const selected = (key && key === g_selectedAvatarKey);

    const url = avatarUrl(a);
    return `
      <button class="av-card ${locked ? "locked" : ""} ${selected ? "selected" : ""}"
              data-key="${escapeAttr(key)}"
              data-tier="${escapeAttr(tier)}"
              ${locked ? 'disabled title="Premium avatar (donors)"' : 'title="Select avatar"'}>
        <img class="av-img" src="${escapeAttr(url)}" alt="${escapeAttr(key)}"
             onerror="this.style.opacity=0.2;" />
        <div class="av-tier">${escapeHtml(tier.toUpperCase())}</div>
        ${locked ? '<div class="av-lock">LOCK</div>' : ""}
      </button>
    `;
  }

  host.innerHTML = `
    <div class="av-section">
      <div class="av-title">Standard</div>
      <div class="av-grid">${standard.map(card).join("")}</div>
    </div>

    <div class="av-section">
      <div class="av-title">Premium</div>
      <div class="av-subtitle">${g_isPremiumUser ? "Unlocked" : "Donate to unlock"}</div>
      <div class="av-grid">${premium.map(card).join("")}</div>
    </div>
  `;

  host.querySelectorAll(".av-card").forEach(btn => {
    btn.addEventListener("click", () => {
      const key = btn.getAttribute("data-key") || "";
      const tier = btn.getAttribute("data-tier") || "standard";
      g_selectedAvatarKey = key;

      // update preview in create character row
      const prev = document.getElementById("newCharAvatarPreview");
      if (prev){
        const idx = g_avatarIndex;
        const baseUrl = String(idx?.baseUrl || AVATAR_BASE_URL).replace(/\/+$/, "");
        const url = (baseUrl && key) ? (baseUrl + "/" + key) : "";
        prev.style.backgroundImage = url ? `url('${url}')` : "";
        updateAvatarMiniButtonState();
      }

      const out = document.getElementById("avatarSelectedOut");
      if (out) out.textContent = "Selected: " + key + " (" + tier + ")";

      // re-render to show selected border
      renderAvatarPicker(indexJson);
      // close picker automatically (optional). Comment out if you want it to stay open.
      hideAvatarOverlay();
    });
  });

  const out = document.getElementById("avatarSelectedOut");
  if (out) out.textContent = g_selectedAvatarKey ? ("Selected: " + g_selectedAvatarKey) : "Selected: (none)";
}

/* Wire buttons */
document.addEventListener("DOMContentLoaded", () => {
  const btnPick = document.getElementById("btnPickAvatar");
  if (btnPick){
    btnPick.addEventListener("click", async () => {
      showAvatarOverlay();
      const host = document.getElementById("avatarPickerHost");
      if (host) host.innerHTML = '<div class="best-card"><div class="best-muted">Loading...</div></div>';

      try{
        const idx = await loadAvatarIndex(false);
        renderAvatarPicker(idx);
      }catch(e){
        if (host) host.innerHTML = '<div class="best-error">Avatar list failed to load: ' + escapeHtml(e.message) + '</div>';
      }
    });
  }

  const btnClose = document.getElementById("btnAvatarClose");
  if (btnClose) btnClose.addEventListener("click", hideAvatarOverlay);

  const btnRefresh = document.getElementById("btnAvatarRefresh");
  if (btnRefresh){
    btnRefresh.addEventListener("click", async () => {
      const host = document.getElementById("avatarPickerHost");
      if (host) host.innerHTML = '<div class="best-card"><div class="best-muted">Loading...</div></div>';
      try{
        const idx = await loadAvatarIndex(true);
        renderAvatarPicker(idx);
      }catch(e){
        if (host) host.innerHTML = '<div class="best-error">Avatar list failed to load: ' + escapeHtml(e.message) + '</div>';
      }
    });
  }
});
/* ================= END AVATAR PICKER (STANDARD/PREMIUM) ================= */

function openHelp(){
  // hook this into your help overlay, modal, or chat later
  window.open(
    "https://gameinfo.daraempire.com/ui/help.html",
    "_blank",
    "noopener"
  );
}

function openImprint(){
  window.open(
    "https://gameinfo.daraempire.com/legal-notice-imprint/",
    "_blank",
    "noopener"
  );
}

function updateAvatarMiniButtonState(){
  const btn = document.getElementById("btnPickAvatar");
  const prev = document.getElementById("newCharAvatarPreview");
  if (!btn || !prev) return;

  const bg = (prev.style.backgroundImage || "").trim();
  const hasAvatar = bg && bg !== "none";

  btn.classList.toggle("has-avatar", !!hasAvatar);
}
  </script>

</body>
</html>
